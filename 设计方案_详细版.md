# CFGO: Causal Flow Graph Optimization è®¾è®¡æ–¹æ¡ˆï¼ˆè¯¦ç»†ç‰ˆï¼‰

**ç‰ˆæœ¬ï¼š** v2.0  
**æœ€åæ›´æ–°ï¼š** 2025-11  
**å®ç°çŠ¶æ€ï¼š** ğŸŸ¢ æ ¸å¿ƒåŠŸèƒ½å·²å®ç° | ğŸŸ¡ éƒ¨åˆ†å®ç° | ğŸ”´ å¾…å®ç°

---

## ğŸ“‹ **ç›®å½•**

1. [ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ](#ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ)
2. [è®­ç»ƒé˜¶æ®µï¼šFree Train GRPO](#è®­ç»ƒé˜¶æ®µfree-train-grpo)
3. [æ¨ç†é˜¶æ®µ](#æ¨ç†é˜¶æ®µ)
   - [Step 1: Multi-Agent DAG Generation](#step-1-multi-agent-dag-generation)
   - [Step 2: DAG Enhancement Pipeline](#step-2-dag-enhancement-pipeline)
   - [Step 3: LLM-Based Computation](#step-3-llm-based-computation)
4. [å®éªŒè®¾è®¡](#å®éªŒè®¾è®¡)
5. [æŠ€æœ¯å®ç°ç»†èŠ‚](#æŠ€æœ¯å®ç°ç»†èŠ‚)
6. [æ–‡ä»¶ç»“æ„](#æ–‡ä»¶ç»“æ„)

---

## ğŸ—ï¸ **ç³»ç»Ÿæ¶æ„æ¦‚è§ˆ**

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CFGO System Architecture                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è®­ç»ƒé˜¶æ®µ (Training Stage) - Free Train GRPO          ğŸŸ¢ å·²å®ç°  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”œâ”€ Generator 1 (+ Experience Library)                            â”‚
â”‚  â”œâ”€ Generator 2 (+ Experience Library)                            â”‚
â”‚  â”œâ”€ Generator 3 (+ Experience Library)                            â”‚
â”‚  â””â”€ Critic     (+ Experience Library)                             â”‚
â”‚                                                                    â”‚
â”‚  è®­ç»ƒæ•°æ®: AIME 2024 (30é¢˜) + AIME 2025 (30é¢˜) + ç‰©ç†é¢˜ (30é¢˜)  â”‚
â”‚  è®­ç»ƒæœºåˆ¶: åŠ¨æ€ç»éªŒç®¡ç† (Add/Modify/Delete)                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ¨ç†é˜¶æ®µ (Reasoning Stage)                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                    â”‚
â”‚  Step 1: Multi-Agent DAG Generation            ğŸŸ¢ å·²å®ç°         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Input: æ•°å­¦/ç‰©ç†é—®é¢˜æ–‡æœ¬                              â”‚     â”‚
â”‚  â”‚                                                          â”‚     â”‚
â”‚  â”‚  Generator 1 (with experience) â”€â”€â”                     â”‚     â”‚
â”‚  â”‚  Generator 2 (with experience) â”€â”€â”¤â†’ Parallel Generate  â”‚     â”‚
â”‚  â”‚  Generator 3 (with experience) â”€â”€â”˜                     â”‚     â”‚
â”‚  â”‚                    â†“                                    â”‚     â”‚
â”‚  â”‚             Critic Fusion                               â”‚     â”‚
â”‚  â”‚                    â†“                                    â”‚     â”‚
â”‚  â”‚  Output: Fixed DAG (åˆæ­¥èåˆçš„å› æœå›¾)                  â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                    â”‚
â”‚  Step 2: DAG Enhancement Pipeline                                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Input: Fixed DAG                                       â”‚     â”‚
â”‚  â”‚                                                          â”‚     â”‚
â”‚  â”‚  Stage 1: Domain Expert Review & Correction  ğŸŸ¢ å·²å®ç° â”‚     â”‚
â”‚  â”‚    â”œâ”€ Math Expert Agent                                â”‚     â”‚
â”‚  â”‚    â”œâ”€ Physics Expert Agent                             â”‚     â”‚
â”‚  â”‚    â””â”€ Output: Corrected DAG                            â”‚     â”‚
â”‚  â”‚                    â†“                                    â”‚     â”‚
â”‚  â”‚  Stage 2: RAG Knowledge Enhancement         ğŸŸ¡ éƒ¨åˆ†å®ç°â”‚     â”‚
â”‚  â”‚    â”œâ”€ Knowledge Gap Identification (LLM)               â”‚     â”‚
â”‚  â”‚    â”œâ”€ Knowledge Retrieval (AI/Vector)                  â”‚     â”‚
â”‚  â”‚    â””â”€ Knowledge Injection (å¾…ä¼˜åŒ–ä¸ºLLMé©±åŠ¨)            â”‚     â”‚
â”‚  â”‚                    â†“                                    â”‚     â”‚
â”‚  â”‚  Stage 3: Causal Structure Optimization     ğŸŸ¢ å·²å®ç°  â”‚     â”‚
â”‚  â”‚    â”œâ”€ Pattern Analysis (Chain/Fork/Collider)          â”‚     â”‚
â”‚  â”‚    â”œâ”€ Structural Issues Detection                      â”‚     â”‚
â”‚  â”‚    â””â”€ Output: Optimized DAG                            â”‚     â”‚
â”‚  â”‚                    â†“                                    â”‚     â”‚
â”‚  â”‚  Output: Enhanced DAG (å¤šç»´åº¦å¢å¼ºçš„å› æœå›¾)             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                              â†“                                    â”‚
â”‚  Step 3: LLM-Based Computation                 ğŸŸ¢ å·²å®ç°         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Input: Enhanced DAG                                    â”‚     â”‚
â”‚  â”‚                                                          â”‚     â”‚
â”‚  â”‚  LLM Computer:                                          â”‚     â”‚
â”‚  â”‚    â”œâ”€ Parse Computation Plan                           â”‚     â”‚
â”‚  â”‚    â”œâ”€ Execute Steps (LLM-based)                        â”‚     â”‚
â”‚  â”‚    â””â”€ Synthesize Final Answer                          â”‚     â”‚
â”‚  â”‚                                                          â”‚     â”‚
â”‚  â”‚  Output: Final Answer + Reasoning Chain                â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  è¯„ä¼°é˜¶æ®µ (Evaluation Stage)                      ğŸ”´ å¾…å®ç°      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”œâ”€ Causal Intervention (å› æœå¹²é¢„) - CFæŒ‡æ ‡                      â”‚
â”‚  â”œâ”€ Abductive Reasoning (æº¯å› æ¨ç†) - ACæŒ‡æ ‡                      â”‚
â”‚  â””â”€ Answer Accuracy (ç­”æ¡ˆå‡†ç¡®ç‡) - pass@1                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“ **è®­ç»ƒé˜¶æ®µï¼šFree Train GRPO**

![GRPO Architecture](https://cdn.nlark.com/yuque/0/2025/svg/27201149/1762354346351-abf60723-706d-43aa-8d0a-23e316f44b2c.svg)

### **ğŸŸ¢ å®ç°çŠ¶æ€ï¼šå·²å®Œæˆ**

### **æ ¸å¿ƒæ€æƒ³**

ç”±äºLLMåœ¨æ„é€ SCMï¼ˆStructural Causal Modelï¼‰æ—¶ç»å¸¸å‡ºç°å¤±è¯¯ï¼Œè¿™äº›ä¸Šæ¸¸é”™è¯¯ä¼šå¯¼è‡´ä¸‹æ¸¸è®¡ç®—é”™è¯¯å’Œæ¨ç†é“¾é”™è¯¯ã€‚æˆ‘ä»¬æå‡º**Free Train GRPO**æ¨¡å—ï¼Œå€Ÿé‰´GRPOï¼ˆGroup Relative Policy Optimizationï¼‰æ€æƒ³ï¼Œå°†è®­ç»ƒçš„å‚æ•°ç©ºé—´è½¬ç§»åˆ°**ä¸Šä¸‹æ–‡ç©ºé—´**ï¼ˆå³ç»éªŒåº“ï¼‰ï¼Œåœ¨å°‘æ ·æœ¬æ•°æ®é›†ä¸Šå³å¯è¾¾åˆ°æ¥è¿‘GRPOçš„æ•ˆæœã€‚

### **è®­ç»ƒæµç¨‹**

#### **ç¬¬ä¸€æ­¥ï¼šå¤šè½®Rolloutç”Ÿæˆ**

**Generatorè®­ç»ƒï¼š**
```python
# å®ç°æ–‡ä»¶ï¼šgrpo_training/generator1.py, generator2.py, generator3.py

å¯¹æ¯ä¸ªé—®é¢˜ï¼š
  for rollout in range(3):  # æ¯é¢˜ç”Ÿæˆ3ä¸ªrollout
    1. GeneratoråŠ è½½è‡ªå·±çš„ç»éªŒåº“
    2. åŸºäºç»éªŒç”ŸæˆDAG
    3. ä½¿ç”¨LLM Computerè®¡ç®—ç­”æ¡ˆ
    4. è®°å½• (scaffold, answer)
```

**Criticè®­ç»ƒï¼š**
```python
# å®ç°æ–‡ä»¶ï¼šgrpo_training/critic.py

å¯¹æ¯ä¸ªé—®é¢˜ï¼š
  for fusion in range(3):  # å¯¹æ¯ä¸ªGeneratorçš„rolloutsè¿›è¡Œèåˆ
    1. CriticåŠ è½½è‡ªå·±çš„ç»éªŒåº“
    2. èåˆGeneratorçš„rollouts
    3. ç”ŸæˆFused DAG
    4. è®¡ç®—ç­”æ¡ˆ
    5. è®°å½• (fused_dag, answer)
```

#### **ç¬¬äºŒæ­¥ï¼šå¥–åŠ±è®¡ç®—**

**Generatorå¥–åŠ±å‡½æ•°ï¼š**
```python
# å®ç°æ–‡ä»¶ï¼šgrpo_training/experience_extractor.py

r_total = Î± * r_ans + Î² * r_logic + Î³ * r_graph

å…¶ä¸­ï¼š
- r_ansï¼šç­”æ¡ˆå‡†ç¡®åº¦ (0 æˆ– 1)
- r_logicï¼šé€»è¾‘åˆç†æ€§ (åŸºäºDAGç»“æ„è´¨é‡)
- r_graphï¼šå› æœå›¾å®Œæ•´æ€§
- æƒé‡ï¼šÎ±=0.6, Î²=0.25, Î³=0.15
```

**Criticå¥–åŠ±å‡½æ•°ï¼š**
```python
r_total = Î± * r_ans + Î² * r_logic + Î³ * r_graph + Î´ * r_fusion

é¢å¤–å¢åŠ ï¼š
- r_fusionï¼šèåˆè´¨é‡ (è¡¡é‡èåˆçš„æœ‰æ•ˆæ€§)
- æƒé‡ï¼šÎ±=0.6, Î²=0.25, Î³=0.15, Î´=0.1
```

#### **ç¬¬ä¸‰æ­¥ï¼šåŠ¨æ€ç»éªŒæå–**

**ğŸ†• æ ¸å¿ƒåˆ›æ–°ï¼šåŠ¨æ€ç»éªŒç®¡ç†**

```python
# å®ç°æ–‡ä»¶ï¼šgrpo_training/experience_extractor.py

LLMåˆ†æ3ä¸ªrolloutsçš„å·®å¼‚ï¼Œè¾“å‡ºï¼š
{
  "operations": [
    {
      "action": "add",
      "content": "æ–°ç»éªŒï¼ˆâ‰¤32å­—ï¼‰",
      "category": "dag_structure|formula_usage|reasoning_strategy",
      "reason": "ä¸ºä»€ä¹ˆæ·»åŠ è¿™æ¡ç»éªŒ"
    },
    {
      "action": "modify",
      "id": "G1-003",
      "content": "æ›´æ–°åçš„ç»éªŒ",
      "reason": "ä¸ºä»€ä¹ˆä¿®æ”¹"
    },
    {
      "action": "delete",
      "id": "G1-001",
      "reason": "ä¸ºä»€ä¹ˆåˆ é™¤ï¼ˆè¿‡æ—¶/é”™è¯¯/å†—ä½™ï¼‰"
    }
  ]
}
```

**ç»éªŒåº“æ–‡ä»¶ï¼š**
```
data/grpo_experiences/
  â”œâ”€ generator_1_experiences.json
  â”œâ”€ generator_2_experiences.json
  â”œâ”€ generator_3_experiences.json
  â””â”€ critic_experiences.json
```

#### **ç¬¬å››æ­¥ï¼šç»éªŒåº“æ›´æ–°ç­–ç•¥**

**æ–¹å·®é˜ˆå€¼æœºåˆ¶ï¼ˆç±»ä¼¼KLæ•£åº¦ï¼‰ï¼š**
```python
if std(rewards) > Ï„:  # Ï„ = 0.05
    æ‰§è¡Œç»éªŒæå–ï¼ˆæœ‰æ˜æ˜¾å·®å¼‚ï¼Œå€¼å¾—å­¦ä¹ ï¼‰
else:
    è·³è¿‡ï¼ˆæ€§èƒ½ç›¸è¿‘ï¼Œæ— æ–°ä¿¡æ¯ï¼‰
```

**é˜²æ­¢ç»éªŒåº“è¿‡å¤§ï¼š**
- æ¯æ¡ç»éªŒâ‰¤32å­—
- å®šæœŸè¯„ä¼°ç»éªŒçš„æœ‰æ•ˆæ€§
- åˆ é™¤è¿‡æ—¶æˆ–å†—ä½™çš„ç»éªŒ

### **è®­ç»ƒé…ç½®**

| å‚æ•° | å€¼ | è¯´æ˜ |
|-----|-----|-----|
| Temperature | 0.7 | è®­ç»ƒé˜¶æ®µï¼Œä¿æŒæ¢ç´¢æ€§ |
| Rollouts per problem | 3 | æ¯é¢˜ç”Ÿæˆ3ä¸ªrollout |
| GRPO threshold (Ï„) | 0.05 | æ–¹å·®é˜ˆå€¼ |
| Epochs | 3 | å®Œæ•´è®­ç»ƒè½®æ•° |
| Experience max length | 32 words | ç»éªŒå†…å®¹é•¿åº¦é™åˆ¶ |

### **è®­ç»ƒæ•°æ®é›†**

| æ•°æ®é›† | é¢˜ç›®æ•° | é¢†åŸŸ |
|-------|--------|------|
| AIME 2024 | 30 | é«˜éš¾åº¦æ•°å­¦æ¨ç† |
| AIME 2025-I | 15 | æ•°å­¦ï¼ˆç¬¬ä¸€åœºï¼‰|
| AIME 2025-II | 15 | æ•°å­¦ï¼ˆç¬¬äºŒåœºï¼‰|
| ç‰©ç†ç«èµ›é¢˜ | 30 | ç‰©ç†æ¨ç† |
| **æ€»è®¡** | **90é¢˜** | **æ··åˆ** |

### **å®ç°æ–‡ä»¶æ¸…å•**

- âœ… `grpo_training/generator1.py` - Generator 1è®­ç»ƒè„šæœ¬
- âœ… `grpo_training/generator2.py` - Generator 2è®­ç»ƒè„šæœ¬
- âœ… `grpo_training/generator3.py` - Generator 3è®­ç»ƒè„šæœ¬
- âœ… `grpo_training/critic.py` - Criticè®­ç»ƒè„šæœ¬
- âœ… `grpo_training/experience_extractor.py` - åŠ¨æ€ç»éªŒæå–
- âœ… `prompts/generator_experience_extraction.txt` - Generatorç»éªŒæå–prompt
- âœ… `prompts/critic_experience_extraction.txt` - Criticç»éªŒæå–prompt
- âœ… `data/grpo_experiences/` - ç»éªŒåº“å­˜å‚¨

---

## ğŸ§  **æ¨ç†é˜¶æ®µ**

![Reasoning Stage](https://cdn.nlark.com/yuque/0/2025/svg/27201149/1762354890497-04294c78-97b3-452a-9874-d5b29a664299.svg)

æ¨ç†é˜¶æ®µåˆ†ä¸º3ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š**DAGç”Ÿæˆ**ã€**DAGå¢å¼º**ã€**è®¡ç®—æ‰§è¡Œ**

---

### **Step 1: Multi-Agent DAG Generation**

#### **ğŸŸ¢ å®ç°çŠ¶æ€ï¼šå·²å®Œæˆ**

#### **è¾“å…¥**
æ•°å­¦/ç‰©ç†é—®é¢˜æ–‡æœ¬

#### **æ¶æ„è®¾è®¡**

**å¤šæ™ºèƒ½ä½“å¹¶è¡Œç”Ÿæˆï¼š**
```python
# å®ç°æ–‡ä»¶ï¼šengine/multi_agent_scaffolder.py

class MultiAgentScaffolder:
    def __init__(self, use_separate_apis=True):
        # ä¸ºæ¯ä¸ªagentåˆ†é…ç‹¬ç«‹çš„API key
        self.generator_1_client = LLMClient(api_key=generator_1_api)
        self.generator_2_client = LLMClient(api_key=generator_2_api)
        self.generator_3_client = LLMClient(api_key=generator_3_api)
        self.critic_client = LLMClient(api_key=critic_api)
    
    def generate_scaffold_parallel(self, problem_text):
        # æ­¥éª¤1ï¼šå¹¶è¡Œç”Ÿæˆ
        with ThreadPoolExecutor(max_workers=3) as executor:
            futures = [
                executor.submit(self._single_agent_generate, 1, problem_text),
                executor.submit(self._single_agent_generate, 2, problem_text),
                executor.submit(self._single_agent_generate, 3, problem_text)
            ]
            proposals = [f.result() for f in futures]
        
        # æ­¥éª¤2ï¼šCriticèåˆ
        fused_dag = self._critic_fusion(problem_text, proposals)
        return fused_dag
```

**ç‹¬ç«‹ç»éªŒåŠ è½½ï¼š**
```python
def _single_agent_generate(self, agent_id, problem_text):
    # æ¯ä¸ªagentåŠ¨æ€åŠ è½½è‡ªå·±çš„ç»éªŒåº“
    experiences = self._load_agent_experiences(f'generator_{agent_id}')
    
    prompt = self.generator_prompt.format(
        problem_text=problem_text,
        prior_experiences=experiences,  # æ³¨å…¥ç»éªŒ
        retrieved_knowledge=""  # RAGçŸ¥è¯†ï¼ˆå½“å‰ä¸ºç©ºï¼‰
    )
    
    scaffold = self.generator_client.complete(prompt)
    return scaffold
```

**Criticèåˆç­–ç•¥ï¼š**
```python
def _critic_fusion(self, problem_text, proposals):
    # Criticä¹ŸåŠ è½½è‡ªå·±çš„ç»éªŒåº“
    experiences = self._load_agent_experiences('critic')
    
    prompt = self.critic_prompt.format(
        problem_text=problem_text,
        prior_experiences=experiences,
        generator_1_dag=proposals[0],
        generator_2_dag=proposals[1],
        generator_3_dag=proposals[2]
    )
    
    fused_dag = self.critic_client.complete(prompt)
    return fused_dag
```

#### **è¾“å‡º**
**Fixed DAG** - åˆæ­¥èåˆçš„å› æœå›¾ï¼ŒåŒ…å«ï¼š
```json
{
  "target_variable": "æœ€ç»ˆæ±‚è§£ç›®æ ‡",
  "expected_answer_type": "Numerical|Expression|Tuple|...",
  "knowns": {"å·²çŸ¥é‡": "å€¼", ...},
  "causal_graph": [
    {"cause": ["åŸå› å˜é‡"], "effect": "ç»“æœå˜é‡", "rule": "å…¬å¼"}
  ],
  "computation_plan": [
    {"id": "step1", "target": "ä¸­é—´å˜é‡", "inputs": [...], "description": "..."}
  ],
  "problem_model": "é—®é¢˜å»ºæ¨¡",
  "chosen_strategy": "æ±‚è§£ç­–ç•¥"
}
```

#### **å…³é”®ç‰¹æ€§**

1. **å¹¶è¡Œç”Ÿæˆ**ï¼š3ä¸ªGeneratoråŒæ—¶å·¥ä½œï¼Œæé«˜æ•ˆç‡
2. **ç‹¬ç«‹API**ï¼šæ¯ä¸ªagentä½¿ç”¨ä¸åŒçš„API keyï¼Œé¿å…rate limit
3. **ç»éªŒé©±åŠ¨**ï¼šæ¯ä¸ªagentåŸºäºè‡ªå·±çš„ç»éªŒåº“ç”Ÿæˆ
4. **å¤šæ ·æ€§ä¿è¯**ï¼š3ä¸ªç‹¬ç«‹è§†è§’ï¼ŒCriticè´Ÿè´£å»åè§

#### **å®ç°æ–‡ä»¶æ¸…å•**

- âœ… `engine/scaffolder.py` - å•æ™ºèƒ½ä½“Scaffolder
- âœ… `engine/multi_agent_scaffolder.py` - å¤šæ™ºèƒ½ä½“Scaffolder
- âœ… `prompts/scaffolding_prompt_v3.txt` - DAGç”Ÿæˆprompt
- âœ… `prompts/critic_prompt.txt` - Criticèåˆprompt
- âœ… `utils/api_key_manager.py` - APIå¯†é’¥ç®¡ç†

---

### **Step 2: DAG Enhancement Pipeline**

#### **ğŸŸ¡ å®ç°çŠ¶æ€ï¼šå¤§éƒ¨åˆ†å®Œæˆï¼ŒStage 2å¾…ä¼˜åŒ–**

#### **è¾“å…¥**
Fixed DAGï¼ˆæ¥è‡ªStep 1ï¼‰

#### **æ•´ä½“æ¶æ„**

```python
# å®ç°æ–‡ä»¶ï¼šengine/dag_enhancement_pipeline.py

class DAGEnhancementPipeline:
    def enhance_dag(self, fixed_dag, problem_text):
        current_dag = fixed_dag
        
        # Stage 1: Domain Expert Review & Correction
        current_dag, expert_report = self.expert_reviewer.review_dag(
            current_dag, problem_text
        )
        
        # Stage 2: RAG Knowledge Enhancement
        current_dag, rag_report = self.rag_enhancer.enhance_dag_with_knowledge(
            current_dag, problem_text
        )
        
        # Stage 3: Causal Structure Optimization
        current_dag, structure_report = self.structure_optimizer.optimize_causal_structure(
            current_dag, problem_text
        )
        
        return current_dag, comprehensive_report
```

---

#### **Stage 1: Domain Expert Review & Correction**

##### **ğŸŸ¢ å®ç°çŠ¶æ€ï¼šå·²å®Œæˆ**

**æ ¸å¿ƒåŠŸèƒ½ï¼š** é¢†åŸŸä¸“å®¶ï¼ˆæ•°å­¦å®¶/ç‰©ç†å­¦å®¶ï¼‰å®¡æŸ¥å¹¶**ä¸»åŠ¨ä¿®æ­£**DAGä¸­çš„é”™è¯¯

**å·¥ä½œæµç¨‹ï¼š**
```
Input: Fixed DAG
  â†“
è¯†åˆ«é—®é¢˜é¢†åŸŸï¼ˆmath/physics/mixedï¼‰
  â†“
è°ƒç”¨å¯¹åº”ä¸“å®¶LLMå®¡æŸ¥
  â†“
ä¸“å®¶è¯†åˆ«é”™è¯¯ï¼š
  - å…¬å¼é”™è¯¯
  - ç‰©ç†è¿è§„
  - é€»è¾‘é”™è¯¯
  - å•ä½ä¸ä¸€è‡´
  â†“
ä¸“å®¶ç”Ÿæˆcorrected_dagï¼ˆå®Œæ•´çš„ä¿®æ­£åDAGï¼‰
  â†“
Output: Corrected DAG
```

**Promptè®¾è®¡ï¼š**
```python
# æ–‡ä»¶ï¼šprompts/expert_review_prompt.txt

Your task is to **review and actively correct** the following causal DAG.

**Your Tasks:**
1. Automatically identify if this is math, physics, or mixed problem
2. Verify formulas, theorems, and physical laws are correctly applied
3. Check logical validity and unit consistency
4. Identify errors and provide specific corrections
5. **Generate a corrected DAG** with all fixes applied (most important!)

**Output JSON:**
{
  "problem_domain": "math|physics|mixed",
  "issues": [
    {"node": "...", "issue": "...", "severity": "high|medium|low", "category": "..."}
  ],
  "corrections": [
    {"node": "...", "original": "...", "corrected": "...", "reason": "..."}
  ],
  "corrected_dag": {
    "target_variable": "...",
    "knowns": {...},  // âœ… å·²ä¿®æ­£
    "causal_graph": [...],  // âœ… å·²ä¿®æ­£
    "computation_plan": [...]  // âœ… å·²ä¿®æ­£
  },
  "overall_assessment": "..."
}
```

**å…³é”®æ”¹è¿›ç‚¹ï¼š**
- âŒ æ—§ç‰ˆï¼šåªè¯†åˆ«é”™è¯¯ï¼Œè¿”å›ä¿®æ­£å»ºè®®ï¼ˆæ–‡å­—æè¿°ï¼‰
- âœ… æ–°ç‰ˆï¼šè¯†åˆ«é”™è¯¯ + **ç”Ÿæˆå®Œæ•´çš„ä¿®æ­£åDAG**

**å®ç°æ–‡ä»¶ï¼š**
- âœ… `engine/domain_expert_reviewer.py`
- âœ… `prompts/expert_review_prompt.txt`
- âœ… æ–‡æ¡£ï¼š`engine/Stage1æ”¹è¿›å®Œæˆè¯´æ˜.md`

---

#### **Stage 2: RAG Knowledge Enhancement**

##### **ğŸŸ¡ å®ç°çŠ¶æ€ï¼šéƒ¨åˆ†å®Œæˆï¼ˆå¾…ä¼˜åŒ–ï¼‰**

**æ ¸å¿ƒåŠŸèƒ½ï¼š** è¯†åˆ«çŸ¥è¯†ç¼ºå£ï¼Œæ£€ç´¢ç›¸å…³çŸ¥è¯†ï¼Œæ³¨å…¥åˆ°DAGä¸­

**å·¥ä½œæµç¨‹ï¼š**
```
Input: Corrected DAG
  â†“
Step 1: è¯†åˆ«çŸ¥è¯†ç¼ºå£ï¼ˆLLMï¼‰âœ…
  - ç¼ºå¤±çš„å…¬å¼
  - ç¼ºå¤±çš„å®šç†
  - ç¼ºå¤±çš„ç‰©ç†å¸¸æ•°
  - ä¸å®Œæ•´çš„æ¨ç†é“¾
  â†“
Step 2: æ£€ç´¢ç›¸å…³çŸ¥è¯† âœ…
  - AI Retrieverï¼ˆåŠ¨æ€ç”ŸæˆçŸ¥è¯†ï¼‰
  - Vector Retrieverï¼ˆä»çŸ¥è¯†åº“æ£€ç´¢ï¼‰
  â†“
Step 3: æ³¨å…¥çŸ¥è¯†åˆ°DAG âš ï¸ å¾…ä¼˜åŒ–
  - å½“å‰ï¼šåªæ·»åŠ metadata
  - ç›®æ ‡ï¼šçœŸæ­£ä¿®æ”¹DAGç»“æ„
  â†“
Output: Knowledge-Enhanced DAG
```

**å½“å‰é—®é¢˜ï¼š**
```python
# å½“å‰å®ç°ï¼ˆengine/rag_knowledge_enhancer.pyï¼‰

def _inject_knowledge_into_dag(self, dag, knowledge_rules):
    enhanced_dag = copy.deepcopy(dag)
    
    # âŒ åªæ·»åŠ metadataï¼Œæ²¡æœ‰ä¿®æ”¹DAGç»“æ„
    enhanced_dag['knowledge_base'] = []
    for kr in knowledge_rules:
        enhanced_dag['knowledge_base'].append(kr)
    
    # âŒ æ³¨é‡Šè¯´"Optionally: Try to integrate rules..."ï¼Œä½†æ²¡å®ç°
    return enhanced_dag
```

**æ”¹è¿›æ–¹æ¡ˆï¼šLLMé©±åŠ¨çš„çŸ¥è¯†æ³¨å…¥**

```python
# æ–°å¢ï¼šprompts/knowledge_injection_prompt.txt

**Given:**
- Current DAG
- Identified knowledge gaps
- Retrieved knowledge (formulas, theorems, constants)

**Tasks:**
1. Analyze which retrieved knowledge is applicable
2. Decide how to inject knowledge into DAG:
   a) add_to_knowns: Add constants (e.g., g=9.8)
   b) new_edge: Add new causal relationship
   c) enhance_edge: Enhance existing rule description
   d) new_step: Add new computation step
3. Output complete knowledge_enhanced_dag

**Output JSON:**
{
  "applicable_knowledge": [
    {"rule": "...", "application_type": "add_to_knowns|new_edge|...", "reasoning": "..."}
  ],
  "knowledge_enhanced_dag": {
    "target_variable": "...",
    "knowns": {...},  // âœ… å¯èƒ½æ·»åŠ äº†æ–°å¸¸æ•°
    "causal_graph": [...],  // âœ… å¯èƒ½æ·»åŠ äº†æ–°å…³ç³»
    "computation_plan": [...]  // âœ… å¯èƒ½æ·»åŠ äº†æ–°æ­¥éª¤
  },
  "reasoning": "..."
}
```

**å®ç°æ–‡ä»¶ï¼š**
- âœ… `engine/rag_knowledge_enhancer.py`ï¼ˆåŸºç¡€æ¡†æ¶ï¼‰
- âœ… `prompts/knowledge_gap_identification_prompt.txt`
- ğŸ”´ `prompts/knowledge_injection_prompt.txt`ï¼ˆå¾…åˆ›å»ºï¼‰
- ğŸ”´ `_llm_inject_knowledge`æ–¹æ³•ï¼ˆå¾…å®ç°ï¼‰

---

#### **Stage 3: Causal Structure Optimization**

##### **ğŸŸ¢ å®ç°çŠ¶æ€ï¼šå·²å®Œæˆ**

**æ ¸å¿ƒåŠŸèƒ½ï¼š** ä½¿ç”¨å› æœæ¨æ–­çš„3ç§åŸºæœ¬ç»“æ„ä¼˜åŒ–DAG

**3ç§å› æœæ¨¡å¼ï¼š**

1. **Chainï¼ˆé“¾ç»“æ„ï¼‰ï¼šX â†’ Z â†’ Y**
   - Zæ˜¯ä¸­ä»‹å˜é‡
   - ç”¨äºï¼šä¿®å¤è·³æ­¥ï¼ˆè¡¥å……ä¸­é—´å˜é‡ï¼‰
   - ç¤ºä¾‹ï¼š`mass â†’ force â†’ acceleration`

2. **Forkï¼ˆå‰ç»“æ„ï¼‰ï¼šX â† Z â†’ Y**
   - Zæ˜¯å…¬å› ï¼ˆcommon causeï¼‰
   - ç”¨äºï¼šæ•´ç†"ä¸€å› å¤šæœ"å…³ç³»
   - ç¤ºä¾‹ï¼š`temperature â† heating â†’ pressure`

3. **Colliderï¼ˆå¯¹æ’ç»“æ„ï¼‰ï¼šX â†’ Z â† Y**
   - Zæ˜¯å…¬æœï¼ˆcommon effectï¼‰
   - ç”¨äºï¼šæ•´ç†"å¤šå› ä¸€æœ"å…³ç³»
   - ç¤ºä¾‹ï¼š`height â†’ potential_energy â† mass`

**å·¥ä½œæµç¨‹ï¼š**
```
Input: Knowledge-Enhanced DAG
  â†“
Step 1: ç†è§£å› æœæ¨¡å¼ï¼ˆChain/Fork/Colliderï¼‰
  â†“
Step 2: æ£€æµ‹ç»“æ„é—®é¢˜
  - ç¯è·¯ï¼ˆcyclesï¼‰
  - å­¤ç«‹èŠ‚ç‚¹
  - è·³æ­¥
  - è®¡ç®—é¡ºåºé”™è¯¯
  â†“
Step 3: ç”¨å› æœæ¨¡å¼ä¿®å¤DAG
  - ç”¨Chainä¿®å¤è·³æ­¥
  - ç”¨Fork/Collideré‡æ„æ··ä¹±å…³ç³»
  - ä¼˜åŒ–è®¡ç®—é¡ºåº
  â†“
Output: Optimized DAG
```

**Promptè®¾è®¡ï¼ˆæ ¸å¿ƒç†å¿µï¼‰ï¼š**
```python
# æ–‡ä»¶ï¼šprompts/causal_structure_optimization_prompt.txt

**Core Philosophy:**
The three causal patterns are NOT just for identification - 
they are your **active tools** for restructuring and fixing messy DAGs.

**Your Tasks:**
1. **Understand Causal Patterns (Your Toolkit):**
   - Chain: A â†’ B â†’ C (use to fix skipped steps)
   - Fork: A â† B â†’ C (use when one cause affects multiple effects)
   - Collider: A â†’ B â† C (use when multiple causes lead to one effect)

2. **Detect Structural Issues:**
   - Cycles, isolated nodes, skipped steps, wrong order

3. **Optimize Using Patterns:**
   - Fix skipped steps: Insert intermediate variables (Chain)
   - Clarify relationships: Restructure as Fork or Collider
   - Reorder computation_plan based on topological order

**Output JSON:**
{
  "issues_detected": [...],
  "modifications_made": [
    "Applied Chain pattern: mass â†’ force â†’ acceleration",
    "Applied Fork pattern: temperature â† heating â†’ pressure"
  ],
  "optimized_dag": {...},  // âœ… å®Œæ•´çš„ä¼˜åŒ–åDAG
  "causal_patterns": {
    "chains": [{"path": [...], "applied": "å¦‚ä½•ä½¿ç”¨"}],
    "forks": [...],
    "colliders": [...]
  },
  "reasoning": "..."
}
```

**å…³é”®æ”¹è¿›ç‚¹ï¼š**
- âŒ æ—§ç‰ˆï¼šåªè¯†åˆ«æ¨¡å¼ï¼Œä¸çŸ¥é“å¦‚ä½•ä½¿ç”¨
- âœ… æ–°ç‰ˆï¼š**å°†æ¨¡å¼ä½œä¸ºä¿®å¤å·¥å…·**ï¼Œä¸»åŠ¨é‡æ„DAG

**å®ç°æ–‡ä»¶ï¼š**
- âœ… `engine/causal_structure_optimizer.py`
- âœ… `prompts/causal_structure_optimization_prompt.txt`
- âœ… æ–‡æ¡£ï¼š`prompts/Stage3_å› æœæ¨¡å¼åº”ç”¨è¯´æ˜.md`

---

#### **è¾“å‡ºï¼šEnhanced DAG**

ç»è¿‡3ä¸ªStageå¢å¼ºåçš„é«˜è´¨é‡å› æœå›¾ï¼Œç‰¹ç‚¹ï¼š
- âœ… **æ­£ç¡®æ€§**ï¼šStage 1ä¿®æ­£äº†æ•°å­¦/ç‰©ç†é”™è¯¯
- âœ… **å®Œæ•´æ€§**ï¼šStage 2è¡¥å……äº†ç¼ºå¤±çš„çŸ¥è¯†
- âœ… **é²æ£’æ€§**ï¼šStage 3ä¼˜åŒ–äº†ç»“æ„ï¼Œä¿®å¤äº†è·³æ­¥å’Œæ··ä¹±å…³ç³»

#### **å®ç°æ–‡ä»¶æ¸…å•**

- âœ… `engine/dag_enhancement_pipeline.py` - å¢å¼ºæµæ°´çº¿åè°ƒå™¨
- âœ… `engine/domain_expert_reviewer.py` - Stage 1
- ğŸŸ¡ `engine/rag_knowledge_enhancer.py` - Stage 2ï¼ˆå¾…ä¼˜åŒ–ï¼‰
- âœ… `engine/causal_structure_optimizer.py` - Stage 3
- âœ… `prompts/expert_review_prompt.txt`
- âœ… `prompts/knowledge_gap_identification_prompt.txt`
- ğŸ”´ `prompts/knowledge_injection_prompt.txt`ï¼ˆå¾…åˆ›å»ºï¼‰
- âœ… `prompts/causal_structure_optimization_prompt.txt`
- âœ… æ–‡æ¡£ï¼š`engine/enhance_dagå®Œæ•´æµç¨‹æ¨¡æ‹Ÿç¤ºä¾‹.md`

---

### **Step 3: LLM-Based Computation**

#### **ğŸŸ¢ å®ç°çŠ¶æ€ï¼šå·²å®Œæˆ**

#### **è¾“å…¥**
Enhanced DAGï¼ˆæ¥è‡ªStep 2ï¼‰

#### **å·¥ä½œæµç¨‹**

```python
# å®ç°æ–‡ä»¶ï¼šengine/llm_computer.py

class LLMComputer:
    def compute_from_scaffold(self, causal_plan, problem_text):
        # Step 1: è§£æcomputation_plan
        steps = causal_plan['computation_plan']
        
        # Step 2: æŒ‰é¡ºåºæ‰§è¡Œæ¯ä¸ªæ­¥éª¤ï¼ˆLLMè®¡ç®—ï¼‰
        context = {}
        for step in steps:
            step_result = self._execute_single_step(
                step, context, causal_plan
            )
            context[step['id']] = step_result
        
        # Step 3: åˆæˆæœ€ç»ˆç­”æ¡ˆ
        final_answer = self._synthesize_answer(context, causal_plan)
        
        return {
            'answer': final_answer,
            'reasoning_chain': context,
            'computation_steps': steps
        }
```

**LLMé©±åŠ¨çš„è®¡ç®—ï¼š**
```python
def _execute_single_step(self, step, context, causal_plan):
    prompt = f"""
    You are a mathematical reasoning assistant.
    
    **Problem:** {problem_text}
    
    **Knowns:** {causal_plan['knowns']}
    
    **Current Step:**
    - Target: {step['target']}
    - Description: {step['description']}
    - Inputs: {step['inputs']}
    
    **Previous Results:** {context}
    
    Calculate {step['target']} step by step.
    """
    
    result = self.llm_client.complete(prompt)
    return result
```

#### **è¾“å‡º**
```json
{
  "answer": "æœ€ç»ˆç­”æ¡ˆ",
  "reasoning_chain": {
    "step1": "ä¸­é—´ç»“æœ1",
    "step2": "ä¸­é—´ç»“æœ2",
    ...
  },
  "computation_steps": [...],
  "success": true
}
```

#### **å®ç°æ–‡ä»¶æ¸…å•**

- âœ… `engine/llm_computer.py` - LLMè®¡ç®—å¼•æ“
- âœ… `main.py` - ä¸»æµç¨‹è°ƒç”¨

---

## ğŸ§ª **å®éªŒè®¾è®¡**

### **æ•°æ®é›†é…ç½®**

#### **è®­ç»ƒé˜¶æ®µæ•°æ®é›†ï¼ˆFree Train GRPOï¼‰**

| æ•°æ®é›† | é¢˜ç›®æ•° | é¢†åŸŸ | ç”¨é€” |
|--------|--------|------|------|
| AIME 2024 | 30 | æ•°å­¦ | GRPOç»éªŒç§¯ç´¯ |
| AIME 2025-I | 15 | æ•°å­¦ | GRPOç»éªŒç§¯ç´¯ |
| AIME 2025-II | 15 | æ•°å­¦ | GRPOç»éªŒç§¯ç´¯ |
| ç‰©ç†ç«èµ›é¢˜ | 30 | ç‰©ç† | GRPOç»éªŒç§¯ç´¯ |
| **æ€»è®¡** | **90é¢˜** | **æ··åˆ** | - |

#### **æµ‹è¯•é˜¶æ®µæ•°æ®é›†ï¼ˆReasoning & Evaluationï¼‰**

| æ•°æ®é›† | è§„æ¨¡ | éš¾åº¦ | é¢†åŸŸ |
|--------|------|------|------|
| GSM8K | ~7K | å°å­¦æ•°å­¦ | åŸºç¡€æ¨ç† |
| MATH | ~12K | ç«èµ›çº§ | é«˜é˜¶æ•°å­¦ |
| OlympiadBench | ~8K | å¥¥èµ›çº§ | æ•°å­¦+ç‰©ç† |
| Omni-MATH | ~4.5K | ç»¼åˆ | æ³›åŒ–èƒ½åŠ› |
| ç‰©ç†ç«èµ›é¢˜ï¼ˆæµ‹è¯•é›†ï¼‰ | ~100 | ç«èµ›çº§ | ç‰©ç†æ¨ç† |

### **å®éªŒé…ç½®**

#### **æ¨¡å‹å‚æ•°**

| å‚æ•° | è®­ç»ƒé˜¶æ®µ | æ¨ç†é˜¶æ®µ |
|------|---------|---------|
| Temperature | 0.7 | 0.0 |
| Rollouts per problem | 3 | 1 |
| Max tokens | 4096 | 8192 |
| GRPO threshold (Ï„) | 0.05 | - |

#### **å¥–åŠ±æƒé‡**

**Generatorï¼š**
```
r_total = 0.6 * r_ans + 0.25 * r_logic + 0.15 * r_graph
```

**Criticï¼š**
```
r_total = 0.6 * r_ans + 0.25 * r_logic + 0.15 * r_graph + 0.1 * r_fusion
```

---

### **å¯¹æ¯”å®éªŒï¼ˆBaseline Comparisonï¼‰**

| æ–¹æ³• | GSM8K | MATH | OlympiadBench | Omni-MATH | Physics |
|------|-------|------|---------------|-----------|---------|
| **Zero-shot** | pass@1 / CF / AC | pass@1 / CF / AC | pass@1 / CF / AC | pass@1 / CF / AC | pass@1 / CF / AC |
| **Few-shot CoT** | - | - | - | - | - |
| **Zero-shot CoT** | - | - | - | - | - |
| **ToT** | - | - | - | - | - |
| **GoT** | - | - | - | - | - |
| **CFGO (Ours)** | - | - | - | - | - |

**Baselineæ–¹æ³•è¯´æ˜ï¼š**

1. **Zero-shot**ï¼šç›´æ¥è®©LLMå›ç­”ï¼Œæ— ä»»ä½•æç¤º
2. **Few-shot CoT**ï¼šChain-of-Thoughtï¼Œç»™3ä¸ªç¤ºä¾‹
3. **Zero-shot CoT**ï¼šä½¿ç”¨"Let's think step by step"æç¤º
4. **ToT (Tree of Thoughts)**ï¼šæ ‘çŠ¶æœç´¢æ¨ç†
5. **GoT (Graph of Thoughts)**ï¼šå›¾çŠ¶æœç´¢æ¨ç†
6. **CFGO (Ours)**ï¼šå®Œæ•´æµç¨‹ï¼ˆGRPOè®­ç»ƒ + Multi-Agent + Enhancementï¼‰

**è¯„ä¼°æŒ‡æ ‡è¯´æ˜ï¼š**

- **pass@1**ï¼šç­”æ¡ˆå‡†ç¡®ç‡ï¼ˆä¸€æ¬¡æ€§æ­£ç¡®ç‡ï¼‰
- **CF (Counterfactual Faithfulness)**ï¼šæ€ç»´é“¾å¿ è¯šåº¦ï¼ˆ0-1åˆ†æ•°ï¼‰ ğŸ”´ å¾…å®ç°
- **AC (Abductive Consistency)**ï¼šé€†å› æœä¸€è‡´æ€§ï¼ˆ0-1åˆ†æ•°ï¼‰ ğŸ”´ å¾…å®ç°

---

### **æ¶ˆèå®éªŒï¼ˆAblation Studyï¼‰**

| å˜ä½“ | GSM8K | MATH | OlympiadBench | è¯´æ˜ |
|------|-------|------|---------------|------|
| **CFGO (Full)** | pass@1 / CF / AC | pass@1 / CF / AC | pass@1 / CF / AC | å®Œæ•´æ–¹æ³• |
| **CFGO-woGRPO** | - | - | - | ç§»é™¤GRPOè®­ç»ƒ |
| **CFGO-woMultiAgent** | - | - | - | å•agentï¼ˆæ— å¹¶è¡Œç”Ÿæˆï¼‰|
| **CFGO-woEnhancement** | - | - | - | ç§»é™¤å¢å¼ºé˜¶æ®µ |
| **CFGO-woExpert** | - | - | - | ä»…ç§»é™¤é¢†åŸŸä¸“å®¶ |
| **CFGO-woRAG** | - | - | - | ä»…ç§»é™¤RAG |
| **CFGO-woCausal** | - | - | - | ä»…ç§»é™¤å› æœä¼˜åŒ– |
| **CFGO-woEvaluation** | - | - | - | ç§»é™¤å› æœè¯„ä¼° ğŸ”´ |

**æ¶ˆèå®éªŒç›®çš„ï¼š**

1. **CFGO-woGRPO**ï¼šéªŒè¯GRPOè®­ç»ƒçš„å¿…è¦æ€§
2. **CFGO-woMultiAgent**ï¼šéªŒè¯å¤šæ™ºèƒ½ä½“æ¶æ„çš„ä»·å€¼
3. **CFGO-woEnhancement**ï¼šéªŒè¯æ•´ä¸ªå¢å¼ºé˜¶æ®µçš„è´¡çŒ®
4. **CFGO-woExpert**ï¼šéªŒè¯é¢†åŸŸä¸“å®¶çš„ä½œç”¨
5. **CFGO-woRAG**ï¼šéªŒè¯çŸ¥è¯†æ£€ç´¢çš„é‡è¦æ€§
6. **CFGO-woCausal**ï¼šéªŒè¯å› æœç»“æ„ä¼˜åŒ–çš„æ•ˆæœ
7. **CFGO-woEvaluation**ï¼šéªŒè¯å› æœè¯„ä¼°çš„ä»·å€¼

---

### **æ¡ˆä¾‹åˆ†æï¼ˆQualitative Analysisï¼‰**

é€‰å–å…¸å‹é¢˜ç›®è¿›è¡Œå¯è§†åŒ–åˆ†æï¼š

1. **DAGæ¼”åŒ–è¿‡ç¨‹**
   - Fixed DAGï¼ˆStep 1è¾“å‡ºï¼‰
   - Corrected DAGï¼ˆStage 1è¾“å‡ºï¼‰
   - Knowledge-Enhanced DAGï¼ˆStage 2è¾“å‡ºï¼‰
   - Optimized DAGï¼ˆStage 3è¾“å‡ºï¼‰

2. **å› æœæ¨¡å¼åº”ç”¨ç¤ºä¾‹**
   - Chainæ¨¡å¼ä¿®å¤è·³æ­¥
   - Forkæ¨¡å¼æ•´ç†å…¬å› 
   - Collideræ¨¡å¼æ•´ç†å…¬æœ

3. **å¤šæ™ºèƒ½ä½“èåˆç¤ºä¾‹**
   - Generator 1/2/3çš„ç‹¬ç«‹è¾“å‡º
   - Criticçš„èåˆç­–ç•¥
   - æœ€ç»ˆFixed DAG

4. **é”™è¯¯æ¡ˆä¾‹åˆ†æ** ğŸ”´ å¾…å®ç°
   - çŸ¥è¯†ç¼ºå¤±å¯¼è‡´çš„å¤±è´¥
   - æ¨ç†é”™è¯¯å¯¼è‡´çš„å¤±è´¥
   - å› æœå…³ç³»é”™è¯¯å¯¼è‡´çš„å¤±è´¥

---

### **ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒ**

- ä½¿ç”¨**é…å¯¹tæ£€éªŒ**ï¼ˆpaired t-testï¼‰æ¯”è¾ƒCFGOä¸å„baseline
- æ˜¾è‘—æ€§æ°´å¹³ï¼š**p < 0.05**
- æ¯ä¸ªæ•°æ®é›†è‡³å°‘**100+æµ‹è¯•æ ·æœ¬**ä»¥ä¿è¯ç»Ÿè®¡æœ‰æ•ˆæ€§

---

## ğŸ› ï¸ **æŠ€æœ¯å®ç°ç»†èŠ‚**

### **æ ¸å¿ƒæŠ€æœ¯æ ˆ**

| ç»„ä»¶ | æŠ€æœ¯ | è¯´æ˜ |
|------|------|------|
| LLM Backend | OpenAI API / Claude API | æ”¯æŒå¤šç§LLM |
| å¹¶å‘æ‰§è¡Œ | ThreadPoolExecutor | å¤šæ™ºèƒ½ä½“å¹¶è¡Œ |
| å›¾æ“ä½œ | NetworkX | DAGç»“æ„åˆ†æ |
| å‘é‡æ£€ç´¢ | FAISS / ChromaDB | RAGçŸ¥è¯†åº“ |
| é…ç½®ç®¡ç† | python-dotenv | APIå¯†é’¥ç®¡ç† |

### **APIå¯†é’¥ç®¡ç†**

```python
# æ–‡ä»¶ï¼šutils/api_key_manager.py

class APIKeyManager:
    def __init__(self):
        self.keys = {
            'generator_1': os.getenv('GENERATOR_1_API'),
            'generator_2': os.getenv('GENERATOR_2_API'),
            'generator_3': os.getenv('GENERATOR_3_API'),
            'critic': os.getenv('CRITIC_API'),
            'math_expert': os.getenv('MATH_EXPERT_API'),
            'physics_expert': os.getenv('PHYSICS_EXPERT_API'),
            'causal_expert': os.getenv('CAUSAL_KNOWLEDGE_API')
        }
```

**ç¯å¢ƒå˜é‡é…ç½®ï¼ˆ.envï¼‰ï¼š**
```bash
# Multi-Agent Scaffolder APIs
GENERATOR_1_API=sk-...
GENERATOR_2_API=sk-...
GENERATOR_3_API=sk-...
CRITIC_API=sk-...

# Enhancement Pipeline APIs
MATH_EXPERT_API=sk-...
PHYSICS_EXPERT_API=sk-...
CAUSAL_KNOWLEDGE_API=sk-...
```

### **å¹¶å‘æ§åˆ¶**

```python
# å¹¶è¡Œç”Ÿæˆ3ä¸ªproposals
with ThreadPoolExecutor(max_workers=3) as executor:
    futures = {
        executor.submit(self._single_agent_generate, i, problem_text): i
        for i in range(1, 4)
    }
    proposals = [futures[f].result() for f in as_completed(futures)]
```

### **JSON SchemaéªŒè¯**

æ‰€æœ‰LLMè¾“å‡ºéƒ½ä½¿ç”¨ä¸¥æ ¼çš„JSON SchemaéªŒè¯ï¼š

```python
def _validate_dag_structure(self, dag: Dict[str, Any]) -> bool:
    required_fields = ['target_variable', 'knowns', 'causal_graph', 'computation_plan']
    for field in required_fields:
        if field not in dag:
            return False
    
    # éªŒè¯causal_graphç»“æ„
    for edge in dag['causal_graph']:
        if not all(k in edge for k in ['cause', 'effect', 'rule']):
            return False
    
    # éªŒè¯computation_planç»“æ„
    for step in dag['computation_plan']:
        if not all(k in step for k in ['id', 'target', 'inputs', 'description']):
            return False
    
    return True
```

---

## ğŸ“ **æ–‡ä»¶ç»“æ„**

```
hope_code/
â”œâ”€â”€ main.py                           # ä¸»å…¥å£
â”œâ”€â”€ .env                              # ç¯å¢ƒå˜é‡é…ç½®
â”œâ”€â”€ è®¾è®¡æ–¹æ¡ˆ.md                       # åŸå§‹è®¾è®¡æ–¹æ¡ˆ
â”œâ”€â”€ è®¾è®¡æ–¹æ¡ˆ_è¯¦ç»†ç‰ˆ.md                # æœ¬æ–‡æ¡£
â”‚
â”œâ”€â”€ engine/                           # æ ¸å¿ƒå¼•æ“
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ scaffolder.py                 # ğŸŸ¢ å•æ™ºèƒ½ä½“Scaffolder
â”‚   â”œâ”€â”€ multi_agent_scaffolder.py     # ğŸŸ¢ å¤šæ™ºèƒ½ä½“Scaffolder
â”‚   â”œâ”€â”€ llm_computer.py               # ğŸŸ¢ LLMè®¡ç®—å¼•æ“
â”‚   â”œâ”€â”€ dag_enhancement_pipeline.py   # ğŸŸ¢ å¢å¼ºæµæ°´çº¿
â”‚   â”œâ”€â”€ domain_expert_reviewer.py     # ğŸŸ¢ Stage 1: ä¸“å®¶å®¡æŸ¥
â”‚   â”œâ”€â”€ rag_knowledge_enhancer.py     # ğŸŸ¡ Stage 2: RAGå¢å¼ºï¼ˆå¾…ä¼˜åŒ–ï¼‰
â”‚   â””â”€â”€ causal_structure_optimizer.py # ğŸŸ¢ Stage 3: ç»“æ„ä¼˜åŒ–
â”‚
â”œâ”€â”€ grpo_training/                    # ğŸŸ¢ GRPOè®­ç»ƒæ¨¡å—
â”‚   â”œâ”€â”€ generator1.py                 # Generator 1è®­ç»ƒ
â”‚   â”œâ”€â”€ generator2.py                 # Generator 2è®­ç»ƒ
â”‚   â”œâ”€â”€ generator3.py                 # Generator 3è®­ç»ƒ
â”‚   â”œâ”€â”€ critic.py                     # Criticè®­ç»ƒ
â”‚   â””â”€â”€ experience_extractor.py       # åŠ¨æ€ç»éªŒæå–
â”‚
â”œâ”€â”€ prompts/                          # Promptæ¨¡æ¿
â”‚   â”œâ”€â”€ scaffolding_prompt_v3.txt            # ğŸŸ¢ DAGç”Ÿæˆ
â”‚   â”œâ”€â”€ critic_prompt.txt                    # ğŸŸ¢ Criticèåˆ
â”‚   â”œâ”€â”€ expert_review_prompt.txt             # ğŸŸ¢ ä¸“å®¶å®¡æŸ¥
â”‚   â”œâ”€â”€ knowledge_gap_identification_prompt.txt # ğŸŸ¢ çŸ¥è¯†ç¼ºå£è¯†åˆ«
â”‚   â”œâ”€â”€ knowledge_injection_prompt.txt       # ğŸ”´ çŸ¥è¯†æ³¨å…¥ï¼ˆå¾…åˆ›å»ºï¼‰
â”‚   â”œâ”€â”€ causal_structure_optimization_prompt.txt # ğŸŸ¢ ç»“æ„ä¼˜åŒ–
â”‚   â”œâ”€â”€ generator_experience_extraction.txt  # ğŸŸ¢ Generatorç»éªŒæå–
â”‚   â””â”€â”€ critic_experience_extraction.txt     # ğŸŸ¢ Criticç»éªŒæå–
â”‚
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ grpo_experiences/             # ğŸŸ¢ ç»éªŒåº“
â”‚   â”‚   â”œâ”€â”€ generator_1_experiences.json
â”‚   â”‚   â”œâ”€â”€ generator_2_experiences.json
â”‚   â”‚   â”œâ”€â”€ generator_3_experiences.json
â”‚   â”‚   â””â”€â”€ critic_experiences.json
â”‚   â””â”€â”€ knowledge_base/               # ğŸ”´ RAGçŸ¥è¯†åº“ï¼ˆå¾…å®Œå–„ï¼‰
â”‚
â”œâ”€â”€ utils/                            # å·¥å…·æ¨¡å—
â”‚   â”œâ”€â”€ api_key_manager.py            # ğŸŸ¢ APIå¯†é’¥ç®¡ç†
â”‚   â””â”€â”€ knowledge_retriever.py        # ğŸŸ¡ çŸ¥è¯†æ£€ç´¢ï¼ˆå¾…å®Œå–„ï¼‰
â”‚
â””â”€â”€ docs/                             # æ–‡æ¡£
    â”œâ”€â”€ Stage1æ”¹è¿›å®Œæˆè¯´æ˜.md
    â”œâ”€â”€ Stage3_å› æœæ¨¡å¼åº”ç”¨è¯´æ˜.md
    â”œâ”€â”€ enhance_dagå®Œæ•´æµç¨‹æ¨¡æ‹Ÿç¤ºä¾‹.md
    â”œâ”€â”€ å„Agentç‹¬ç«‹ç»éªŒåº“è®¾è®¡è¯´æ˜.md
    â”œâ”€â”€ åŠ¨æ€ç»éªŒç®¡ç†è¯´æ˜.md
    â””â”€â”€ ...
```

---

## ğŸ“Š **å®ç°çŠ¶æ€æ€»ç»“**

### **ğŸŸ¢ å·²å®Œæˆæ¨¡å—**

1. âœ… **Free Train GRPO**
   - åŠ¨æ€ç»éªŒç®¡ç†ï¼ˆAdd/Modify/Deleteï¼‰
   - 4ä¸ªç‹¬ç«‹ç»éªŒåº“
   - æ–¹å·®é˜ˆå€¼æ§åˆ¶

2. âœ… **Multi-Agent DAG Generation**
   - 3ä¸ªGeneratorå¹¶è¡Œç”Ÿæˆ
   - Criticèåˆå»åè§
   - ç‹¬ç«‹APIç®¡ç†

3. âœ… **Stage 1: Domain Expert Review**
   - Math/Physicsä¸“å®¶LLM
   - ä¸»åŠ¨ä¿®æ­£DAG
   - è¾“å‡ºcorrected_dag

4. âœ… **Stage 3: Causal Structure Optimization**
   - Chain/Fork/Collideræ¨¡å¼åº”ç”¨
   - ç»“æ„é—®é¢˜æ£€æµ‹
   - è¾“å‡ºoptimized_dag

5. âœ… **LLM-Based Computation**
   - é€æ­¥æ‰§è¡Œcomputation_plan
   - ä¸Šä¸‹æ–‡ä¼ é€’
   - ç­”æ¡ˆåˆæˆ

### **ğŸŸ¡ éƒ¨åˆ†å®Œæˆæ¨¡å—**

1. âš ï¸ **Stage 2: RAG Knowledge Enhancement**
   - âœ… çŸ¥è¯†ç¼ºå£è¯†åˆ«ï¼ˆLLMï¼‰
   - âœ… çŸ¥è¯†æ£€ç´¢ï¼ˆAI/Vectorï¼‰
   - âŒ çŸ¥è¯†æ³¨å…¥ï¼ˆåªåŠ metadataï¼Œå¾…æ”¹ä¸ºLLMé©±åŠ¨ï¼‰

### **ğŸ”´ å¾…å®ç°æ¨¡å—**

1. âŒ **Causal Evaluationï¼ˆå› æœè¯„ä¼°ï¼‰**
   - Causal Interventionï¼ˆå› æœå¹²é¢„ï¼‰
   - Counterfactual Faithfulnessï¼ˆCFæŒ‡æ ‡ï¼‰
   - Abductive Reasoningï¼ˆæº¯å› æ¨ç†ï¼‰
   - Abductive Consistencyï¼ˆACæŒ‡æ ‡ï¼‰

2. âŒ **RAGçŸ¥è¯†åº“**
   - æ•°å­¦/ç‰©ç†çŸ¥è¯†åº“æ„å»º
   - å‘é‡ç´¢å¼•ä¼˜åŒ–

3. âŒ **å®éªŒè¯„ä¼°è„šæœ¬**
   - Baselineå¯¹æ¯”å®éªŒ
   - æ¶ˆèå®éªŒ
   - ç»Ÿè®¡æ˜¾è‘—æ€§æ£€éªŒ

---

## ğŸš€ **åç»­å¼€å‘è®¡åˆ’**

### **Phase 1: å®ŒæˆStage 2ä¼˜åŒ–ï¼ˆé«˜ä¼˜å…ˆçº§ï¼‰**

- [ ] åˆ›å»º`prompts/knowledge_injection_prompt.txt`
- [ ] å®ç°`_llm_inject_knowledge`æ–¹æ³•
- [ ] æµ‹è¯•éªŒè¯çŸ¥è¯†æ³¨å…¥æ•ˆæœ

### **Phase 2: å®ç°å› æœè¯„ä¼°ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰**

- [ ] è®¾è®¡Causal Interventionæœºåˆ¶
- [ ] å®ç°CFï¼ˆCounterfactual Faithfulnessï¼‰è®¡ç®—
- [ ] è®¾è®¡Abductive Reasoningæœºåˆ¶
- [ ] å®ç°ACï¼ˆAbductive Consistencyï¼‰è®¡ç®—

### **Phase 3: å®éªŒè¯„ä¼°ï¼ˆä¸­ä¼˜å…ˆçº§ï¼‰**

- [ ] å‡†å¤‡Baselineå®ç°
- [ ] æ„å»ºæµ‹è¯•æ•°æ®é›†pipeline
- [ ] å®ç°è‡ªåŠ¨åŒ–è¯„ä¼°è„šæœ¬
- [ ] è¿›è¡Œæ¶ˆèå®éªŒ

### **Phase 4: ç³»ç»Ÿä¼˜åŒ–ï¼ˆä½ä¼˜å…ˆçº§ï¼‰**

- [ ] RAGçŸ¥è¯†åº“æ‰©å……
- [ ] æ€§èƒ½ä¼˜åŒ–ï¼ˆç¼“å­˜ã€æ‰¹å¤„ç†ï¼‰
- [ ] é”™è¯¯å¤„ç†å¢å¼º
- [ ] æ—¥å¿—å’Œç›‘æ§å®Œå–„

---

## ğŸ“š **å‚è€ƒæ–‡çŒ®**

1. **GRPO**: Group Relative Policy Optimization
2. **Chain-of-Thought**: Wei et al., 2022
3. **Tree of Thoughts**: Yao et al., 2023
4. **Graph of Thoughts**: Besta et al., 2023
5. **Causal Inference**: Pearl, Judea. "Causality." 2009
6. **Multi-Agent Systems**: Wooldridge, Michael. "An Introduction to MultiAgent Systems." 2009

---

## ğŸ“ **ç‰ˆæœ¬å†å²**

| ç‰ˆæœ¬ | æ—¥æœŸ | æ›´æ–°å†…å®¹ |
|------|------|---------|
| v1.0 | 2025-11 | åˆå§‹è®¾è®¡æ–¹æ¡ˆ |
| v2.0 | 2025-11 | è¯¦ç»†ç‰ˆï¼Œç»“åˆå®é™…å®ç°æ›´æ–° |

---

## âœ‰ï¸ **è”ç³»æ–¹å¼**

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»é¡¹ç›®ç»„ã€‚

---

**ğŸ¯ End of Document**



