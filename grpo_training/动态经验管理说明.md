# GRPO 动态经验管理说明

## 🎯 **核心理念**

GRPO的经验库不是**静态累积**的，而是**动态演化**的：
- ✅ **可以添加**新经验 (add)
- ✅ **可以修改**现有经验 (modify)
- ✅ **可以删除**过时经验 (delete)

## 🔑 **关键设计：RAG知识 vs GRPO经验分离**

为了清晰区分两种不同的知识来源，我们在 `CausalScaffolder.generate_scaffold()` 中使用了**两个独立的参数**：

```python
def generate_scaffold(
    self,
    problem_text: str,
    retrieved_knowledge: List[str],  # RAG检索的知识（公式、定理）
    experiences: Optional[List[str]] = None  # GRPO训练获得的经验
) -> Optional[Dict[str, Any]]:
```

**参数说明：**
- **`retrieved_knowledge`**: RAG系统检索的领域知识（公式、定理、规则）
  - 来源：知识库向量检索、关键词匹配
  - 特点：静态的、标准的、可验证的知识
  - 示例：`"Newton's Second Law: F = ma"`
  
- **`experiences`**: GRPO训练动态积累的经验
  - 来源：LLM分析rollout差异后提炼的经验
  - 特点：动态演化的、特定于问题类型的、可能错误的假设
  - 示例：`"自由落体问题用g=9.8，不要近似为10"`

**为什么要分离？**
1. ✅ **清晰的职责边界** - RAG负责通用知识，GRPO负责问题经验
2. ✅ **独立管理** - 两者可以独立启用/禁用
3. ✅ **提高可读性** - prompt中分开显示，LLM更容易理解
4. ✅ **便于调试** - 可以单独分析哪个来源对结果的影响

**Prompt中的呈现：**
```
CONTEXT:

**Relevant formulas and theorems (from knowledge base):**
1. Newton's Second Law: F = ma
2. Kinematic Equation: v_f = v_i + a*t

**Prior experiences (learned from previous problems):**
1. 自由落体问题用g=9.8 m/s²，公式v²=2gh
2. 计算重力时，直接用F=mg，避免引入错误的加速度a

Problem:
...
```

---

## 🔄 **完整工作流程**

### Step 1: 加载当前经验库

```python
# generator_1的当前经验库
experiences = [
  {
    "id": "G1-001",
    "content": "自由落体问题用g=9.8 m/s²，公式v²=2gh",
    "category": "causal_graph",
    "created_at": "2025-11-08T10:00:00",
    "updated_at": "2025-11-08T10:00:00"
  },
  {
    "id": "G1-002",
    "content": "抛体运动需要分解为水平和竖直两个方向",
    "category": "causal_graph",
    "created_at": "2025-11-08T10:05:00",
    "updated_at": "2025-11-08T10:05:00"
  }
]
```

### Step 2: 生成3个Rollouts

```python
rollouts = [
  {scaffold: {...}, answer: "14 m/s", r_total: 0.95},    # 正确
  {scaffold: {...}, answer: "10 m/s", r_total: 0.24},    # 错误
  {scaffold: {...}, answer: "14.14 m/s", r_total: 0.84}  # 接近
]
```

### Step 3: 送给LLM分析

**输入Prompt：**
```
**CURRENT EXPERIENCES FOR GENERATOR generator_1:**
G1-001: 自由落体问题用g=9.8 m/s²，公式v²=2gh
G1-002: 抛体运动需要分解为水平和竖直两个方向

**GENERATOR generator_1'S PERFORMANCE:**
Rollout 1: [scaffold + 答案 + 分数]
Rollout 2: [scaffold + 答案 + 分数]
Rollout 3: [scaffold + 答案 + 分数]

**YOUR TASK:**
分析差异，决定如何调整经验库（add/modify/delete）
```

### Step 4: LLM决定操作

**场景A：发现新错误，添加新经验**
```json
{
  "operations": [
    {
      "action": "add",
      "content": "计算重力时，不要用F=ma的通用公式，直接用F=mg，避免引入错误的加速度a",
      "category": "causal_graph",
      "reason": "Rollout 2错误地用了a=5而非g=9.8，需要强调重力场景的特殊性"
    }
  ]
}
```

**场景B：发现已有经验不够准确，需要修改**
```json
{
  "operations": [
    {
      "action": "modify",
      "id": "G1-001",
      "content": "自由落体问题必须用g=9.8 m/s²（不能近似为10），公式v²=2gh，不要混用F=ma",
      "reason": "Rollout 3用了g=10导致答案不精确，需要强调必须用9.8"
    }
  ]
}
```

**场景C：发现某经验已过时或错误，需要删除**
```json
{
  "operations": [
    {
      "action": "delete",
      "id": "G1-002",
      "reason": "这条经验关于抛体运动，但当前问题是自由落体，该经验未被使用且与当前问题无关，可能造成干扰"
    }
  ]
}
```

**场景D：综合操作（修改+添加+删除）**
```json
{
  "operations": [
    {
      "action": "modify",
      "id": "G1-001",
      "content": "自由落体：g=9.8（精确值），v²=2gh，不要用F=ma",
      "reason": "需要更精确的描述"
    },
    {
      "action": "add",
      "content": "自由落体的causal_graph应该是单步：(v0,g,h)→v，不需要通过力F中转",
      "category": "causal_graph",
      "reason": "强调因果图结构"
    },
    {
      "action": "delete",
      "id": "G1-002",
      "reason": "与当前问题类型不相关"
    }
  ]
}
```

### Step 5: 应用操作，更新经验库

```python
# 应用操作后的经验库
experiences = [
  {
    "id": "G1-001",
    "content": "自由落体：g=9.8（精确值），v²=2gh，不要用F=ma",  # ← 已修改
    "category": "causal_graph",
    "created_at": "2025-11-08T10:00:00",
    "updated_at": "2025-11-08T15:30:00",  # ← 更新时间
    "last_modified_by": "physics_003"
  },
  # G1-002 已删除
  {
    "id": "G1-003",  # ← 新添加
    "content": "自由落体的causal_graph应该是单步：(v0,g,h)→v，不需要通过力F中转",
    "category": "causal_graph",
    "created_at": "2025-11-08T15:30:00",
    "updated_at": "2025-11-08T15:30:00",
    "source_problem": "physics_003"
  }
]
```

### Step 6: 下次训练时使用更新后的经验库

下次遇到类似问题时，Generator 1会加载这个更新后的经验库，避免之前的错误。

---

## 📊 **对比：静态 vs 动态**

### 静态累积（旧方法，❌）

```
Training Problem 1:
  经验库: []
  → LLM: add G1-001
  经验库: [G1-001]

Training Problem 2:
  经验库: [G1-001]
  → LLM: add G1-002
  经验库: [G1-001, G1-002]

Training Problem 3:
  经验库: [G1-001, G1-002]
  → LLM: add G1-003
  经验库: [G1-001, G1-002, G1-003]

问题：
❌ 经验只增不减，越来越多
❌ 无法纠正错误经验
❌ 冗余经验造成干扰
❌ 经验之间可能矛盾
```

### 动态演化（新方法，✅）

```
Training Problem 1:
  经验库: []
  → LLM: add G1-001
  经验库: [G1-001]

Training Problem 2:
  经验库: [G1-001]
  → LLM: modify G1-001 (发现不够准确)
  经验库: [G1-001(更新版)]

Training Problem 3:
  经验库: [G1-001(更新版)]
  → LLM: add G1-002, delete G1-001 (发现G1-001已过时)
  经验库: [G1-002]

Training Problem 4:
  经验库: [G1-002]
  → LLM: modify G1-002, add G1-003
  经验库: [G1-002(更新版), G1-003]

优势：
✅ 经验质量不断提升
✅ 及时纠正错误
✅ 保持精简，无冗余
✅ 经验始终相关且准确
```

---

## 🎯 **实际示例场景**

### 场景1：纠正错误经验

**初始经验：**
```
G1-001: "物理问题都要先画受力分析图"
```

**遇到自由落体问题：**
- Rollout 1: 没画图，直接用v²=2gh → 正确（r=0.95）
- Rollout 2: 画了复杂受力图 → 浪费时间（r=0.70）

**LLM操作：**
```json
{
  "action": "modify",
  "id": "G1-001",
  "content": "复杂力学问题需要受力分析，但简单运动（如自由落体）直接用运动学公式更高效",
  "reason": "原经验过于绝对，需要区分场景"
}
```

### 场景2：删除冗余经验

**经验库：**
```
G1-001: "自由落体用v²=2gh"
G1-005: "竖直下落用v²=2gh"
```

**LLM发现：**
"G1-005和G1-001实际是同一件事（自由落体=竖直下落），造成冗余"

**LLM操作：**
```json
{
  "action": "delete",
  "id": "G1-005",
  "reason": "与G1-001重复，竖直下落就是自由落体"
}
```

### 场景3：精炼经验

**经验演化过程：**
```
初版 (G1-001): "自由落体问题用g=9.8"

→ 修改1: "自由落体问题用g=9.8 m/s²，公式v²=2gh"
         (补充了单位和公式)

→ 修改2: "自由落体：g=9.8（精确值），v²=2gh，不要用F=ma"
         (强调精确值，避免混淆)

→ 修改3: "自由落体：g=9.8，v²=2gh；causal_graph单步(v0,g,h)→v，不经过F"
         (增加因果图结构指导)
```

---

## 💡 **设计原则**

### 1. **经验是假设，不是真理**
- 经验会随着新数据不断修正
- 允许LLM质疑和修改已有经验
- 鼓励删除不再有效的经验

### 2. **质量优于数量**
- 宁可10条精准经验，不要100条模糊经验
- 定期精简，保持经验库小而精

### 3. **上下文感知**
- 经验需要记录适用场景
- 不同问题类型可能需要不同经验

### 4. **可追溯性**
- 记录经验的创建和修改历史
- 知道哪个问题导致了哪个经验的修改

---

## 🔧 **实现细节**

### 经验JSON结构

```json
{
  "id": "G1-001",
  "content": "经验内容（≤32词）",
  "category": "causal_graph|validation|problem_solving",
  "source_problem": "physics_001",  // 最初来源
  "created_at": "2025-11-08T10:00:00",
  "updated_at": "2025-11-08T15:30:00",  // 最后更新
  "last_modified_by": "physics_003"     // 哪个问题触发的修改
}
```

### 操作类型

| 操作 | 必需字段 | 说明 |
|------|---------|------|
| `add` | `content`, `category`, `reason` | 添加新经验 |
| `modify` | `id`, `content`, `reason` | 修改现有经验 |
| `delete` | `id`, `reason` | 删除经验 |

---

## 📈 **预期效果**

### 训练初期
```
Problem 1-10: 快速积累基础经验
经验库增长：0 → 15条
```

### 训练中期
```
Problem 11-50: 经验质量提升，开始修正和删除
经验库变化：15条 → 20条（但质量提高）
操作分布：add=40%, modify=40%, delete=20%
```

### 训练后期
```
Problem 51-100: 经验库趋于稳定，以修改为主
经验库变化：20条 → 25条（增长缓慢）
操作分布：add=20%, modify=60%, delete=20%
```

### 最终状态
```
经验库：25-30条高质量、互补、准确的经验
Generator性能：稳定在高水平（低方差）
```

---

## ✅ **总结**

**动态经验管理的核心优势：**
1. ✅ **自我纠错**：发现错误经验时及时修正
2. ✅ **持续精炼**：经验内容不断优化
3. ✅ **保持精简**：删除冗余和过时经验
4. ✅ **适应演化**：随着问题类型变化调整经验
5. ✅ **质量提升**：不是越多越好，而是越准越好

**vs 静态累积：**
- 静态：只会add，经验库越来越大，质量参差不齐
- 动态：add/modify/delete结合，经验库保持精简高质

这才是真正的**Training-Free持续学习**！🎉

